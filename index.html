<!DOCTYPE html>
<html>
<head>
  <title>DataboxMVL Sovereign Protocol Suite</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      min-height: 100vh;
      padding: 20px;
      margin: 0;
      overflow-x: auto;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    .header {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    }
    
    h1 {
      color: #1e3c72;
      font-size: 2.5em;
      margin-bottom: 10px;
    }
    
    .subtitle {
      color: #64748b;
      font-size: 1.1em;
    }
    
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 30px;
      margin-bottom: 30px;
    }
    
    .card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    }
    
    .card-title {
      font-size: 1.3em;
      font-weight: 600;
      margin-bottom: 20px;
      color: #1e3c72;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    label {
      display: block;
      margin-bottom: 5px;
      color: #475569;
      font-weight: 500;
      font-size: 0.9em;
    }
    
    input, select {
      width: 100%;
      padding: 10px;
      border: 2px solid #e2e8f0;
      border-radius: 6px;
      font-size: 1em;
      transition: border-color 0.3s;
    }
    
    input:focus, select:focus {
      outline: none;
      border-color: #3b82f6;
    }
    
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      width: 100%;
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
    }
    
    button:active {
      transform: translateY(0);
    }
    
    .trace-viewer {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    }
    
    .trace-filters {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .trace-filters input, .trace-filters select {
      flex: 1;
      min-width: 150px;
    }
    
    .trace-list {
      max-height: 500px;
      overflow-y: auto;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 10px;
    }
    
    .trace-item {
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 6px;
      border-left: 4px solid #3b82f6;
      background: #f8fafc;
      transition: all 0.2s;
    }
    
    .trace-item:hover {
      background: #f1f5f9;
      transform: translateX(5px);
    }
    
    .trace-item.denied {
      border-left-color: #ef4444;
    }
    
    .trace-item.injection {
      border-left-color: #10b981;
    }
    
    .trace-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    
    .trace-tipo {
      font-weight: 600;
      color: #1e3c72;
      text-transform: uppercase;
      font-size: 0.9em;
    }
    
    .trace-action {
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 0.85em;
      font-weight: 600;
    }
    
    .trace-action.injection {
      background: #d1fae5;
      color: #065f46;
    }
    
    .trace-action.denied {
      background: #fee2e2;
      color: #991b1b;
    }
    
    .trace-details {
      color: #64748b;
      font-size: 0.9em;
      margin-top: 8px;
    }
    
    .trace-timestamp {
      color: #94a3b8;
      font-size: 0.85em;
      margin-top: 5px;
    }
    
    .status-message {
      padding: 12px;
      border-radius: 6px;
      margin-top: 15px;
      font-weight: 500;
    }
    
    .status-success {
      background: #d1fae5;
      color: #065f46;
      border: 1px solid #10b981;
    }
    
    .status-error {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #ef4444;
    }
    
    .icon {
      width: 24px;
      height: 24px;
      display: inline-block;
    }
    
    .loading {
      text-align: center;
      padding: 20px;
      color: #64748b;
    }
    
    .spinner {
      border: 3px solid #f3f4f6;
      border-top: 3px solid #3b82f6;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Dashboard specific styles */
    .kpi-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .kpi-card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
      text-align: center;
    }

    .kpi-title {
      font-size: 0.9em;
      color: #64748b;
      margin-bottom: 10px;
      text-transform: uppercase;
      font-weight: 600;
    }

    .kpi-value {
      font-size: 2.5em;
      font-weight: 700;
      color: #1e3c72;
      margin-bottom: 5px;
    }

    .kpi-timestamp {
      font-size: 0.8em;
      color: #94a3b8;
    }

    .dashboard-layout {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 30px;
    }

    .audit-section {
      grid-column: 1;
    }

    .graphs-section {
      grid-column: 2;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .audit-filters {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .filter-input {
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 0.9em;
    }

    .table-container {
      overflow-x: auto;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
    }

    .audit-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
    }

    .audit-table th {
      background: #f8fafc;
      padding: 12px;
      text-align: left;
      font-weight: 600;
      color: #374151;
      border-bottom: 1px solid #e5e7eb;
    }

    .audit-table td {
      padding: 12px;
      border-bottom: 1px solid #f3f4f6;
      font-size: 0.9em;
    }

    .audit-table tr:hover {
      background: #f9fafb;
    }

    .audit-table tr.flagged {
      background: #fef2f2;
      border-left: 4px solid #ef4444;
    }

    .graph-container {
      margin-bottom: 20px;
      padding: 15px;
      background: #f8fafc;
      border-radius: 8px;
    }

    .graph-container h4 {
      margin-bottom: 10px;
      color: #374151;
    }

    .toggle-control-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      border-bottom: 1px solid #e5e7eb;
    }

    .toggle-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      font-size: 0.85em;
      cursor: pointer;
      transition: all 0.2s;
    }

    .toggle-btn:not(.flagged) {
      background: #10b981;
      color: white;
    }

    .toggle-btn.flagged {
      background: #ef4444;
      color: white;
    }

    .btn-primary {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9em;
      font-weight: 600;
      transition: background 0.2s;
    }

    .btn-primary:hover {
      background: #2563eb;
    }

    .btn-secondary {
      background: #64748b;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85em;
      margin-left: 10px;
      transition: background 0.2s;
    }

    .btn-secondary:hover {
      background: #475569;
    }

    .form-control {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 0.9em;
      background: white;
    }

    #dashboardContent, #loginContent {
      position: relative;
      width: 100%;
      min-height: 100vh;
      display: none;
    }

    #dashboardContent.active, #loginContent.active {
      display: block !important;
    }

    @media (max-width: 768px) {
      .dashboard-layout {
        grid-template-columns: 1fr;
      }
      
      .kpi-row {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Main Content -->
  <div id="mainContent">
    <div class="container">
    <div class="header">
      <h1>üõ°Ô∏è DataboxMVL Sovereign Protocol Suite</h1>
      <div class="subtitle">Identity-centric data injection with consent enforcement</div>
      <div style="margin-top: 15px;">
        <button onclick="navigateToDashboard()" class="btn-primary">üìä Persona Flag Audit Dashboard</button>
        <button onclick="setUserRole('compliance'); navigateToDashboard()" class="btn-secondary">Login as Compliance</button>
        <button onclick="setUserRole('service_role'); navigateToDashboard()" class="btn-secondary">Login as Service Role</button>
      </div>
    </div>

    <div class="grid">
      <!-- Microcr√©dito Protocol -->
      <div class="card">
        <div class="card-title">
          <span>üí∞</span>
          Microcr√©dito Protocol
        </div>
        <form id="microcreditoForm">
          <div class="form-group">
            <label>Documento ID</label>
            <input type="text" id="micro_documento" value="XYZ124" required>
          </div>
          <div class="form-group">
            <label>Fecha</label>
            <input type="date" id="micro_fecha" value="2025-01-15" required>
          </div>
          <div class="form-group">
            <label>Monto</label>
            <input type="number" id="micro_monto" value="15000" required>
          </div>
          <button type="submit">Inject Microcr√©dito</button>
          <div id="microStatus"></div>
        </form>
      </div>

      <!-- Empleo Protocol -->
      <div class="card">
        <div class="card-title">
          <span>üíº</span>
          Empleo Protocol
        </div>
        <form id="empleoForm">
          <div class="form-group">
            <label>Documento ID</label>
            <input type="text" id="empleo_documento" value="XYZ124" required>
          </div>
          <div class="form-group">
            <label>Fecha Inicio</label>
            <input type="date" id="empleo_fecha_inicio" value="2025-01-15" required>
          </div>
          <div class="form-group">
            <label>Empresa</label>
            <input type="text" id="empleo_empresa" value="DataboxMVL Corp" required>
          </div>
          <div class="form-group">
            <label>Cargo</label>
            <input type="text" id="empleo_cargo" value="Protocol Engineer" required>
          </div>
          <button type="submit">Inject Empleo</button>
          <div id="empleoStatus"></div>
        </form>
      </div>

      <!-- Ingreso Protocol -->
      <div class="card">
        <div class="card-title">
          <span>üìä</span>
          Ingreso Protocol
        </div>
        <form id="ingresoForm">
          <div class="form-group">
            <label>Documento ID</label>
            <input type="text" id="ingreso_documento" value="XYZ124" required>
          </div>
          <div class="form-group">
            <label>Fuente</label>
            <input type="text" id="ingreso_fuente" value="Salario" required>
          </div>
          <div class="form-group">
            <label>Monto</label>
            <input type="number" id="ingreso_monto" value="50000" required>
          </div>
          <div class="form-group">
            <label>Frecuencia</label>
            <select id="ingreso_frecuencia" required>
              <option value="mensual">Mensual</option>
              <option value="quincenal">Quincenal</option>
              <option value="semanal">Semanal</option>
            </select>
          </div>
          <button type="submit">Inject Ingreso</button>
          <div id="ingresoStatus"></div>
        </form>
      </div>

      <!-- Educaci√≥n Protocol -->
      <div class="card">
        <div class="card-title">
          <span>üéì</span>
          Educaci√≥n Protocol
        </div>
        <form id="educacionForm">
          <div class="form-group">
            <label>Documento ID</label>
            <input type="text" id="educacion_documento" value="XYZ124" required>
          </div>
          <div class="form-group">
            <label>Instituci√≥n</label>
            <input type="text" id="educacion_institucion" value="Universidad Soberana" required>
          </div>
          <div class="form-group">
            <label>Nivel</label>
            <select id="educacion_nivel" required>
              <option value="Licenciatura">Licenciatura</option>
              <option value="Maestr√≠a">Maestr√≠a</option>
              <option value="Doctorado">Doctorado</option>
              <option value="T√©cnico">T√©cnico</option>
            </select>
          </div>
          <div class="form-group">
            <label>Fecha Graduaci√≥n</label>
            <input type="date" id="educacion_fecha_graduacion" value="2020-12-15" required>
          </div>
          <button type="submit">Inject Educaci√≥n</button>
          <div id="educacionStatus"></div>
        </form>
      </div>
    </div>

    <!-- Trace Viewer -->
    <div class="trace-viewer">
      <div class="card-title">
        <span>üìú</span>
        Trace Viewer - Auditor√≠a
      </div>
      
      <div class="trace-filters">
        <input type="text" id="trace_documento" placeholder="Documento ID" value="XYZ124">
        <select id="trace_tipo">
          <option value="">Todos los protocolos</option>
          <option value="microcredito">Microcr√©dito</option>
          <option value="empleo">Empleo</option>
          <option value="ingreso">Ingreso</option>
          <option value="educacion">Educaci√≥n</option>
        </select>
        <button onclick="loadTraces()">Load Traces</button>
      </div>
      
      <div class="trace-list" id="traceList">
        <div class="loading">
          <div class="spinner"></div>
          <p>Click "Load Traces" to fetch audit records</p>
        </div>
      </div>
    </div>
  </div>
  <!-- End Main Content -->

  <!-- Login Page -->
  <div id="loginContent" style="display: none;">
    <div class="container">
      <div class="header">
        <h1>üîê DataboxMVL Authentication</h1>
        <div class="subtitle">Please select your role to continue</div>
      </div>
      
      <div class="card" style="max-width: 500px; margin: 0 auto;">
        <div class="card-title">
          <span>üë§</span>
          Role Selection
        </div>
        
        <div class="form-group">
          <label>Select your role:</label>
          <select id="roleSelect" class="form-control">
            <option value="compliance">Compliance (Read-only)</option>
            <option value="service_role">Service Role (Full Access)</option>
          </select>
        </div>
        
        <button onclick="login()" class="btn-primary">Login</button>
      </div>
    </div>
  </div>

  <!-- Dashboard Page -->
  <div id="dashboardContent" style="display: none;">
    <div class="container">
      <div class="header">
        <h1>üõ°Ô∏è Persona Flag Audit Dashboard</h1>
        <div class="subtitle">Real-time compliance monitoring and audit trail</div>
        <div style="margin-top: 15px;">
          <button onclick="router.navigate('/')" class="btn-secondary">‚Üê Back to Main</button>
          <span id="userRoleDisplay" style="margin-left: 20px; padding: 5px 10px; background: #f0f0f0; border-radius: 4px; font-size: 0.9em;"></span>
        </div>
      </div>

      <!-- KPI Cards Row -->
      <div class="kpi-row">
        <div class="kpi-card">
          <div class="kpi-title">Total Personas</div>
          <div class="kpi-value" id="totalPersonasCount">-</div>
          <div class="kpi-timestamp" id="totalPersonasTimestamp">-</div>
        </div>
        
        <div class="kpi-card">
          <div class="kpi-title">Review Needed</div>
          <div class="kpi-value" id="reviewNeededCount">-</div>
          <div class="kpi-timestamp" id="reviewNeededTimestamp">-</div>
        </div>
        
        <div class="kpi-card">
          <div class="kpi-title">Audit Entries</div>
          <div class="kpi-value" id="auditCountValue">-</div>
          <div class="kpi-timestamp" id="auditCountTimestamp">-</div>
        </div>
      </div>

      <!-- Main Dashboard Layout -->
      <div class="dashboard-layout">
        <!-- Audit Table Section -->
        <div class="audit-section">
          <div class="card">
            <div class="card-title">
              <span>üìã</span>
              Audit Log
            </div>
            
            <!-- Filters -->
            <div class="audit-filters">
              <input type="number" id="filterPersonaId" placeholder="Persona ID" class="filter-input">
              <input type="text" id="filterActor" placeholder="Actor" class="filter-input">
              <input type="date" id="filterStartDate" class="filter-input">
              <input type="date" id="filterEndDate" class="filter-input">
              <button onclick="applyAuditFilters()" class="btn-secondary">Apply Filters</button>
            </div>
            
            <!-- Audit Table -->
            <div class="table-container">
              <table class="audit-table">
                <thead>
                  <tr>
                    <th>Persona ID</th>
                    <th>Field Name</th>
                    <th>Old Value</th>
                    <th>New Value</th>
                    <th>Changed By</th>
                    <th>Changed At</th>
                  </tr>
                </thead>
                <tbody id="auditTableBody">
                  <tr>
                    <td colspan="6" style="text-align: center; padding: 20px;">Loading audit data...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Graphs Section -->
        <div class="graphs-section">
          <div class="card">
            <div class="card-title">
              <span>üìä</span>
              Analytics
            </div>
            
            <div id="changesPerDayGraph" class="graph-container">
              <h4>Changes Per Day</h4>
              <div>Loading...</div>
            </div>
            
            <div id="topActorsGraph" class="graph-container">
              <h4>Top Actors</h4>
              <div>Loading...</div>
            </div>
          </div>

          <!-- Toggle Controls (Service Role Only) -->
          <div id="toggleControls" class="card" style="display: none;">
            <div class="card-title">
              <span>‚öôÔ∏è</span>
              Test Persona Controls
            </div>
            <div id="toggleControlsList">
              Loading controls...
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Demo mode - all functionality works with mock data
    let supabase = null;

    // Global router instance
    let router;

    // Router implementation for handling different routes
    class Router {
      constructor() {
        this.routes = {};
        this.currentRoute = null;
        window.addEventListener('popstate', () => this.handleRoute());
        this.handleRoute();
      }

      addRoute(path, handler) {
        this.routes[path] = handler;
      }

      navigate(path) {
        window.history.pushState({}, '', path);
        this.handleRoute();
      }

      handleRoute() {
        const path = window.location.pathname;
        this.currentRoute = path;
        
        // Check authentication for protected routes
        if (path.startsWith('/dashboard/')) {
          this.checkAuthAndRoute(path);
        } else if (this.routes[path]) {
          this.routes[path]();
        } else {
          // Default route
          this.showMainPage();
        }
      }

      async checkAuthAndRoute(path) {
        const token = this.getAuthToken();
        if (!token) {
          this.navigate('/login');
          return;
        }

        const role = this.decodeTokenRole(token);
        if (role === 'anon' || !role) {
          this.navigate('/login');
          return;
        }

        if (path === '/dashboard/persona-flag-audit') {
          this.showPersonaFlagAuditDashboard(role);
        }
      }

      getAuthToken() {
        // For demo purposes, we'll simulate getting a token from localStorage
        // In a real implementation, this would get the actual JWT token
        return localStorage.getItem('auth_token') || null;
      }

      decodeTokenRole(token) {
        // For demo purposes, we'll simulate token decoding
        // In a real implementation, this would decode the actual JWT
        const demoRole = localStorage.getItem('user_role');
        return demoRole;
      }

      showMainPage() {
        document.getElementById('mainContent').style.display = 'block';
        document.getElementById('dashboardContent').style.display = 'none';
        document.getElementById('loginContent').style.display = 'none';
        
        // Remove active classes
        document.getElementById('dashboardContent').classList.remove('active');
        document.getElementById('loginContent').classList.remove('active');
      }

      showLoginPage() {
        document.getElementById('mainContent').style.display = 'none';
        document.getElementById('dashboardContent').style.display = 'none';
        document.getElementById('loginContent').style.display = 'block';
        
        // Add active class
        document.getElementById('dashboardContent').classList.remove('active');
        document.getElementById('loginContent').classList.add('active');
      }

      showPersonaFlagAuditDashboard(role) {
        document.getElementById('mainContent').style.display = 'none';
        document.getElementById('dashboardContent').style.display = 'block';
        document.getElementById('loginContent').style.display = 'none';
        
        // Add active class
        document.getElementById('dashboardContent').classList.add('active');
        document.getElementById('loginContent').classList.remove('active');
        
        // Display current role
        document.getElementById('userRoleDisplay').textContent = `Role: ${role}`;
        
        // Initialize dashboard with role-based access
        initializePersonaFlagAuditDashboard(role);
      }
    }

    // Dashboard functionality
    let kpiRefreshInterval;
    let graphRefreshInterval;

    async function initializePersonaFlagAuditDashboard(userRole) {
      console.log('Initializing dashboard for role:', userRole);
      
      // Clear any existing intervals
      if (kpiRefreshInterval) clearInterval(kpiRefreshInterval);
      if (graphRefreshInterval) clearInterval(graphRefreshInterval);

      // Initialize KPI cards
      await updateKPICards();
      kpiRefreshInterval = setInterval(updateKPICards, 30000); // 30 seconds

      // Initialize audit table
      await updateAuditTable();

      // Initialize graphs
      await updateGraphs();
      graphRefreshInterval = setInterval(updateGraphs, 60000); // 60 seconds

      // Setup role-based controls
      setupRoleBasedControls(userRole);
    }

    async function updateKPICards() {
      try {
        const timestamp = new Date().toISOString().replace('T', ' ').slice(0, 19) + ' Z';

        // For demo purposes, we'll simulate the queries with mock data
        // In a real implementation, these would be actual Supabase queries

        // Simulate Query 1: Count all personas
        const totalPersonas = Math.floor(Math.random() * 1000) + 500;
        
        // Simulate Query 2: Count personas needing review  
        const reviewNeeded = Math.floor(Math.random() * 50) + 10;
        
        // Simulate Query 3: Count audit entries
        const auditCount = Math.floor(Math.random() * 5000) + 1000;

        // Update KPI cards
        document.getElementById('totalPersonasCount').textContent = totalPersonas;
        document.getElementById('totalPersonasTimestamp').textContent = timestamp;
        
        document.getElementById('reviewNeededCount').textContent = reviewNeeded;
        document.getElementById('reviewNeededTimestamp').textContent = timestamp;
        
        document.getElementById('auditCountValue').textContent = auditCount;
        document.getElementById('auditCountTimestamp').textContent = timestamp;

        console.log('KPI cards updated:', { totalPersonas, reviewNeeded, auditCount });

      } catch (error) {
        console.error('Error updating KPI cards:', error);
        // Set error state
        document.getElementById('totalPersonasCount').textContent = 'Error';
        document.getElementById('reviewNeededCount').textContent = 'Error';
        document.getElementById('auditCountValue').textContent = 'Error';
      }
    }

    async function updateAuditTable(filters = {}) {
      try {
        // For demo purposes, generate mock audit data
        // In a real implementation, this would query private.persona_flag_audit
        
        const mockAuditData = [];
        for (let i = 0; i < 20; i++) {
          const now = new Date();
          const changedAt = new Date(now.getTime() - (i * 3600000)); // Hours ago
          
          mockAuditData.push({
            persona_id: Math.floor(Math.random() * 1000) + 1,
            field_name: ['user_id_review_needed', 'status', 'verification_status'][Math.floor(Math.random() * 3)],
            old_value: Math.random() > 0.5 ? 'true' : 'false',
            new_value: Math.random() > 0.5 ? 'true' : 'false',
            changed_by: ['system', 'admin', 'compliance_officer', 'service_user'][Math.floor(Math.random() * 4)],
            changed_at: changedAt.toISOString()
          });
        }

        // Apply filters (simplified for demo)
        let filteredData = mockAuditData;
        if (filters.personaId) {
          filteredData = filteredData.filter(item => item.persona_id == filters.personaId);
        }
        if (filters.actor) {
          filteredData = filteredData.filter(item => 
            item.changed_by.toLowerCase().includes(filters.actor.toLowerCase())
          );
        }

        renderAuditTable(filteredData);
        console.log('Audit table updated with', filteredData.length, 'entries');

      } catch (error) {
        console.error('Error updating audit table:', error);
        renderAuditTable([]);
      }
    }

    function renderAuditTable(data) {
      const tableBody = document.getElementById('auditTableBody');
      tableBody.innerHTML = '';

      if (data.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = '<td colspan="6" style="text-align: center; padding: 20px;">No audit data found</td>';
        tableBody.appendChild(tr);
        return;
      }

      data.forEach(row => {
        const tr = document.createElement('tr');
        const formattedDate = new Date(row.changed_at).toISOString().replace('T', ' ').slice(0, 19) + ' Z';
        
        // Add red highlight for flagged personas (when new_value is true for review_needed)
        if (row.field_name === 'user_id_review_needed' && row.new_value === 'true') {
          tr.classList.add('flagged');
        }
        
        tr.innerHTML = `
          <td>${row.persona_id}</td>
          <td>${row.field_name || ''}</td>
          <td>${row.old_value || ''}</td>
          <td>${row.new_value || ''}</td>
          <td>${row.changed_by || ''}</td>
          <td>${formattedDate}</td>
        `;
        tableBody.appendChild(tr);
      });
    }

    async function updateGraphs() {
      try {
        // For demo purposes, generate mock graph data
        // In a real implementation, these would be actual aggregated queries
        
        // Mock changes per day data
        const changesPerDay = [];
        for (let i = 6; i >= 0; i--) {
          const date = new Date();
          date.setDate(date.getDate() - i);
          changesPerDay.push({
            day: date.toISOString().split('T')[0],
            count: Math.floor(Math.random() * 50) + 10
          });
        }

        // Mock top actors data
        const topActors = [
          { changed_by: 'system', count: Math.floor(Math.random() * 100) + 50 },
          { changed_by: 'admin', count: Math.floor(Math.random() * 80) + 30 },
          { changed_by: 'compliance_officer', count: Math.floor(Math.random() * 60) + 20 },
          { changed_by: 'service_user', count: Math.floor(Math.random() * 40) + 10 },
          { changed_by: 'automated_system', count: Math.floor(Math.random() * 30) + 5 }
        ].sort((a, b) => b.count - a.count);

        renderGraphs(changesPerDay, topActors);
        console.log('Graphs updated');

      } catch (error) {
        console.error('Error updating graphs:', error);
      }
    }

    function renderGraphs(changesData, actorsData) {
      // Simple text-based graph representation
      const changesGraph = document.getElementById('changesPerDayGraph');
      const actorsGraph = document.getElementById('topActorsGraph');

      if (changesData) {
        changesGraph.innerHTML = '<h4>Changes Per Day</h4>' + 
          changesData.map(item => `
            <div style="margin: 5px 0; padding: 5px; background: white; border-radius: 4px;">
              <strong>${item.day}:</strong> ${item.count} changes
            </div>
          `).join('');
      }

      if (actorsData) {
        actorsGraph.innerHTML = '<h4>Top Actors</h4>' + 
          actorsData.map((item, index) => `
            <div style="margin: 5px 0; padding: 5px; background: white; border-radius: 4px;">
              <strong>#${index + 1} ${item.changed_by}:</strong> ${item.count} changes
            </div>
          `).join('');
      }
    }

    function setupRoleBasedControls(userRole) {
      const toggleControls = document.getElementById('toggleControls');
      
      if (userRole === 'compliance') {
        // Hide all toggle controls for compliance role
        toggleControls.style.display = 'none';
        console.log('Compliance role: toggle controls hidden');
      } else if (userRole === 'service_role') {
        // Show toggle controls only for test personas
        toggleControls.style.display = 'block';
        setupToggleControls();
        console.log('Service role: toggle controls enabled');
      }
    }

    async function setupToggleControls() {
      // For demo purposes, generate mock test personas
      // In a real implementation, this would query actual test personas
      
      const testPersonas = [];
      for (let i = 1; i <= 5; i++) {
        testPersonas.push({
          id: 1000 + i,
          user_id_review_needed: Math.random() > 0.5
        });
      }

      renderToggleControls(testPersonas);
    }

    function renderToggleControls(personas) {
      const container = document.getElementById('toggleControlsList');
      container.innerHTML = '';

      personas.forEach(persona => {
        const div = document.createElement('div');
        div.className = 'toggle-control-item';
        div.innerHTML = `
          <span>Test Persona ${persona.id}</span>
          <button onclick="togglePersonaFlag(${persona.id}, ${!persona.user_id_review_needed})" 
                  class="toggle-btn ${persona.user_id_review_needed ? 'flagged' : ''}">
            ${persona.user_id_review_needed ? 'Remove Flag' : 'Add Flag'}
          </button>
        `;
        container.appendChild(div);
      });
    }

    async function togglePersonaFlag(personaId, newFlag) {
      try {
        console.log(`Toggling persona ${personaId} flag to ${newFlag}`);
        
        // In a real implementation, this would execute:
        // UPDATE public.persona SET user_id_review_needed = $newFlag WHERE id = $personaId
        // The audit entry would be created by a backend trigger
        
        // For demo, simulate the update
        setTimeout(async () => {
          // Refresh the display
          await updateKPICards();
          await updateAuditTable();
          setupToggleControls();
          
          console.log(`Persona ${personaId} flag updated successfully`);
        }, 500);

      } catch (error) {
        console.error('Error toggling persona flag:', error);
      }
    }

    // Login functionality
    function login() {
      const roleSelect = document.getElementById('roleSelect');
      const selectedRole = roleSelect.value;
      
      localStorage.setItem('user_role', selectedRole);
      localStorage.setItem('auth_token', 'demo_token_' + selectedRole);
      
      router.navigate('/dashboard/persona-flag-audit');
    }

    // Make functions globally available
    window.togglePersonaFlag = togglePersonaFlag;
    window.login = login;
    window.navigateToDashboard = () => router.navigate('/dashboard/persona-flag-audit');
    window.setUserRole = (role) => {
      localStorage.setItem('user_role', role);
      localStorage.setItem('auth_token', 'demo_token_' + role);
    };

    // Filter functionality
    window.applyAuditFilters = () => {
      const filters = {
        personaId: document.getElementById('filterPersonaId').value,
        actor: document.getElementById('filterActor').value,
        startDate: document.getElementById('filterStartDate').value,
        endDate: document.getElementById('filterEndDate').value
      };
      updateAuditTable(filters);
    };

    // Load traces function for existing functionality
    window.loadTraces = async function() {
      const documento = document.getElementById('trace_documento').value;
      const tipo = document.getElementById('trace_tipo').value;
      
      const traceList = document.getElementById('traceList');
      traceList.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading traces...</p></div>';
      
      try {
        // Mock trace data for demo
        const mockTraces = [];
        for (let i = 0; i < 10; i++) {
          mockTraces.push({
            persona_id: Math.floor(Math.random() * 1000) + 1,
            field_name: 'user_id_review_needed',
            old_value: 'false',
            new_value: 'true',
            changed_by: 'system',
            changed_at: new Date(Date.now() - i * 3600000).toISOString()
          });
        }

        if (mockTraces.length > 0) {
          traceList.innerHTML = mockTraces.map(trace => `
            <div class="trace-item injection">
              <div class="trace-header">
                <span class="trace-tipo">Persona ${trace.persona_id}</span>
                <span class="trace-action injection">FLAG CHANGE</span>
              </div>
              <div><strong>Field:</strong> ${trace.field_name}</div>
              <div><strong>Old Value:</strong> ${trace.old_value}</div>
              <div><strong>New Value:</strong> ${trace.new_value}</div>
              <div><strong>Changed By:</strong> ${trace.changed_by}</div>
              <div><strong>Date:</strong> ${new Date(trace.changed_at).toLocaleString()}</div>
            </div>
          `).join('');
        } else {
          traceList.innerHTML = '<div class="loading"><p>No traces found</p></div>';
        }
      } catch (error) {
        console.error('Error loading traces:', error);
        traceList.innerHTML = '<div class="loading"><p>Error loading traces</p></div>';
      }
    };

    // Initialize router
    router = new Router();

    // Add routes
    router.addRoute('/', () => router.showMainPage());
    router.addRoute('/login', () => router.showLoginPage());

    console.log('DataboxMVL Dashboard initialized');
    console.log('Current route:', window.location.pathname);
  </script>
</body>
</html>
